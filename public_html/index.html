<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>Tetris</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    </head>
    <body id="all">
        <p id="titulo"></p>
        <p id="puntuacion"></p>
        <p id="puntuacionMax"></p>
        <img src="imagenes/blanc.jpg"    id="blanco"    style="display: none;">
        <img src="imagenes/blau.jpg"       id="azul"       style="display: none;">
        <img src="imagenes/groc.jpg" id="amarillo" style="display: none;">
        <img src="imagenes/lila.jpg" id="lila" style="display: none;">
        <img src="imagenes/rosa.jpg" id="rosa" style="display: none;">
        <img src="imagenes/taronja.jpg" id="taronja" style="display: none;">
        <img src="imagenes/verd.jpg" id="verde" style="display: none;">
        <img src="imagenes/vermell.jpg" id="rojo" style="display: none;">
        <img src="imagenes/negro.jpg" id="negro" style="display: none;">
        <img src="imagenes/gris.jpg" id="gris" style="display: none;">

        <!-- Espai de dibuix -->
        <canvas id="espai" width="350" height="600"> </canvas>
        <script>
            var Juego = {
                mapa: new Array(),
                puntuacion: 0,
                puntuacionMaxima: 0,
                piezaActual: '',
                piezaSiguiente: '',
                intervaloTiempo: 300,
                nivel: 1,
                contadorPiezas: {
                    I: 0,
                    J: 0,
                    L: 0,
                    O: 0,
                    S: 0,
                    T: 0,
                    Z: 0
                },
                borrarCanvas: function () {
                    var canvas = document.getElementById("espai");
                    var ctx = canvas.getContext("2d");
                    ctx.clearRect(0, 0, 350, 600);
                },
                cargarMapa: function () {
                    var canvas = document.getElementById("espai");
                    var ctx = canvas.getContext("2d");
                    this.mostrarInfo();
                    var imagen;
                    //document.write("<h1>TETRIS</h1>")
                    // document.write("Nivel: " + this.nivel + " Puntuación: "
                    // + this.puntuacion + " Puntuación Máxima: " + this.puntuacionMaxima + "<br/><br/>")
                    for (var i = 0; i < this.mapa.length; i++) {
                        for (var j = 0; j < this.mapa[i].length; j++) {
                            if (this.mapa[i][j] == 0) {
                                imagen = document.getElementById("blanco");
                            }
                            if (this.mapa[i][j] == 'B') {
                                imagen = document.getElementById("azul");
                            }
                            if (this.mapa[i][j] == 'A') {
                                imagen = document.getElementById("amarillo");
                            }
                            if (this.mapa[i][j] == 'L') {
                                imagen = document.getElementById("lila");
                            }
                            if (this.mapa[i][j] == 'N') {
                                imagen = document.getElementById("taronja");
                            }
                            if (this.mapa[i][j] == 'M') {
                                imagen = document.getElementById("rosa");
                            }
                            if (this.mapa[i][j] == 'V') {
                                imagen = document.getElementById("verde");
                            }
                            if (this.mapa[i][j] == 'R') {
                                imagen = document.getElementById("rojo");
                            }
                            if (this.mapa[i][j] == 'P') {
                                imagen = document.getElementById("negro");
                            }
                            if (this.mapa[i][j] == 'G') {
                                imagen = document.getElementById("gris");
                            }
                            ctx.drawImage(imagen, j * 21, i * 21, 20, 20);
                            // document.write("<br/>");
                        }
                    }
                },
                iniciarMapa: function () {
                    for (var i = 0; i < 25; i++) {
                        this.mapa.push(['G', 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 'G']);
                    }
                    this.mapa.push(['G', 'G', 'G', 'G', 'G', 'G', 'G', 'G', 'G', 'G', 'G', 'G']);
                },
                mostrarInfo: function () {
                    document.getElementById("titulo").innerHTML = "<h1>TETRIS</h1>";
                    document.getElementById("puntuacion").innerHTML = "Puntuación: " + this.puntuacion;
                    document.getElementById("puntuacionMax").innerHTML = "Puntuación máxima: " + this.puntuacionMaxima;
                },
                calcularPiezaSiguiente: function () {
                    var pieza = Math.floor(Math.random() * (8 - 1) + 1);
                    switch (pieza) {
                        case 1:
                            pieza = new Pieza([[[0, 1, 1, 0], [0, 1, 1, 0], [0, 0, 0, 0], [0, 0, 0, 0]], "amarillo"], 4, 0);
                            this.contadorPiezas['I']++;
                            break;
                        case 2:
                            pieza = new Pieza([[[0, 1, 0, 0], [0, 1, 0, 0], [0, 1, 0, 0], [0, 1, 0, 0]], "lila"], 4, 0);
                            this.contadorPiezas['J']++;
                            break;
                        case 3:
                            pieza = new Pieza([[[0, 1, 1, 0], [1, 1, 0, 0], [0, 0, 0, 0], [0, 0, 0, 0]], "verde"], 4, 0);
                            this.contadorPiezas['L']++;
                            break;
                        case 4:
                            pieza = new Pieza([[[1, 1, 0, 0], [0, 1, 1, 0], [0, 0, 0, 0], [0, 0, 0, 0]], "rojo"], 4, 0);
                            this.contadorPiezas['O']++;
                            break;
                        case 5:
                            pieza = new Pieza([[[0, 1, 0, 0], [0, 1, 0, 0], [0, 1, 1, 0], [0, 0, 0, 0]], "azul"], 4, 0);
                            this.contadorPiezas['S']++;
                            break;
                        case 6:
                            pieza = new Pieza([[[0, 1, 1, 0], [0, 1, 0, 0], [0, 1, 0, 0], [0, 0, 0, 0]], "naranja"], 4, 0);
                            this.contadorPiezas['T']++;
                            break;
                        case 7:
                            pieza = new Pieza([[[1, 1, 1, 0], [0, 1, 0, 0], [0, 0, 0, 0], [0, 0, 0, 0]], "morado"], 4, 0);
                            this.contadorPiezas['Z']++;
                            break;
                    }
                    return pieza;
                },
                interaccionUsuario: function (e) {
                    if (e.code == "ArrowLeft") {
                        Juego.piezaActual.moverIzquierda();
                    }
                    if (e.code == "ArrowRight") {
                        Juego.piezaActual.moverDerecha();
                    }
                },
                movimiento: function () {
                    window.onload = function () {
                        Juego.iniciarMapa();
                        Juego.cargarMapa();
                        Juego.piezaActual = Juego.calcularPiezaSiguiente();
                        Juego.piezaSiguiente = Juego.calcularPiezaSiguiente();
                        console.log(Juego.piezaActual);
                        console.log(Juego.piezaSiguiente);
                        var element = document.getElementById("all");
                        setInterval(function () {
                            element.addEventListener("keydown", Juego.interaccionUsuario);
                            Juego.piezaActual.pintaPieza();
                            Juego.borrarCanvas();
                            Juego.cargarMapa();
                            Juego.piezaActual.baja = Juego.piezaActual.puedeBajar();
                            console.log(Juego.piezaActual.baja);
                            if (Juego.piezaActual.baja == true) {
                                Juego.piezaActual.bajaPieza();
                            } else {
                                Juego.piezaActual.formaYcolor[1] = 'negro';
                                Juego.piezaActual.pintaPieza();
                                Juego.piezaActual = Juego.piezaSiguiente;
                                Juego.piezaSiguiente = Juego.calcularPiezaSiguiente();
                            }
                        }, Juego.intervaloTiempo);
                    }
                }

            };
            var Pieza = function (formaYcolor, horizontal, vertical) {
                this.formaYcolor = formaYcolor;
                this.horizontal = horizontal;
                this.vertical = vertical;
                this.baja = true;
            };
            Pieza.prototype.rotarIzquierda = function () {
                Juego.piezaActual.rotarDerecha();
                Juego.piezaActual.rotarDerecha();
                Juego.piezaActual.rotarDerecha();
            };
            Pieza.prototype.rotarDerecha = function () {
                var forma = Juego.piezaActual.formaYcolor[0];
                var formaNova = new Array();
                for (var i = 0; i < forma.length; i++) {
                    formaNova[i] = new Array();
                    for (var j = 0; j < forma[i].length; j++) {
                        formaNova[i][j] = forma[forma[i].length - 1 - j][i];
                    }
                }
                Juego.piezaActual.formaYcolor[0] = formaNova;
            };
            Pieza.prototype.moverIzquierda = function () {
                var auxiliar;
                switch(Juego.piezaActual.formaYcolor[1]){
                    case 'amarillo':auxiliar=-1;break;
                    case 'lila':auxiliar=-1;break;
                    case 'naranja':auxiliar=-1;break;
                    case 'azul':auxiliar=-1;break;
                    default:auxiliar=0;break;
                }
                if ((Juego.piezaActual.horizontal - 1) > 0+auxiliar) {
                    Juego.piezaActual.horizontal--;
                    return true;
                } else {
                    return false;
                }
            };
            Pieza.prototype.moverDerecha = function () {
                var auxiliar;
                switch(Juego.piezaActual.formaYcolor[1]){
                    case 'lila':auxiliar=1;break;
                    default:auxiliar=0;break;
                }
                if ((Juego.piezaActual.horizontal + 1) < 9+auxiliar) {
                    Juego.piezaActual.horizontal++;
                    return true;
                } else {
                    return false;
                }
            };
            Pieza.prototype.retornarForma = function () {
                return Juego.piezaActual.formaYcolor[0];
            };
            Pieza.prototype.pintaPieza = function () {
                var forma = Juego.piezaActual.formaYcolor[0];
                var vertical = Juego.piezaActual.vertical;
                var horizontal = Juego.piezaActual.horizontal;
                var color = Juego.piezaActual.formaYcolor[1];
                for (var i = 0; i < forma.length; i++) {
                    for (var j = 0; j < forma[i].length; j++) {
                        if (forma[i][j] == 1) {
                            switch (color) {
                                case 'amarillo':
                                    Juego.mapa[vertical + i][horizontal + j] = 'A';
                                    break;
                                case 'lila':
                                    Juego.mapa[vertical + i][horizontal + j] = 'L';
                                    break;
                                case 'verde':
                                    Juego.mapa[vertical + i][horizontal + j] = 'V';
                                    break;
                                case 'rojo':
                                    Juego.mapa[vertical + i][horizontal + j] = 'R';
                                    break;
                                case 'azul':
                                    Juego.mapa[vertical + i][horizontal + j] = 'B';
                                    break;
                                case 'naranja':
                                    Juego.mapa[vertical + i][horizontal + j] = 'N';
                                    break;
                                case 'morado':
                                    Juego.mapa[vertical + i][horizontal + j] = 'M';
                                    break;
                                case 'negro':
                                    Juego.mapa[vertical + i][horizontal + j] = 'P';
                                    break;
                            }

                        }
                    }
                }
            };

            Pieza.prototype.borraPieza = function () {
                var forma = Juego.piezaActual.formaYcolor[0];
                var vertical = Juego.piezaActual.vertical;
                var horizontal = Juego.piezaActual.horizontal;
                for (var i = 0; i < forma.length; i++) {
                    for (var j = 0; j < forma[i].length; j++) {
                        if (forma[i][j] == 1) {
                            Juego.mapa[vertical + i][horizontal + j] = 0;
                        }
                    }
                }
            };

            Pieza.prototype.bajaPieza = function () {
                Juego.piezaActual.borraPieza();
                Juego.piezaActual.vertical = Juego.piezaActual.vertical + 1;
            };

            Pieza.prototype.puedeBajar = function () {
                var forma = Juego.piezaActual.formaYcolor[0];
                var color = Juego.piezaActual.formaYcolor[1];
                var vertical = Juego.piezaActual.vertical;
                var horizontal = Juego.piezaActual.horizontal;
                var auxiliar = 0;
                var puede;
                switch (color) {
                    case 'rojo':
                        auxiliar = -1;
                        break;
                    case 'amarillo':
                        auxiliar = -1;
                        break;
                    case 'azul':
                        auxiliar = -1;
                        break;
                    default:
                        auxiliar = 0;
                        break;
                }
                for (var i = 0; i < forma.length; i++) {
                    for (var j = 0; j < forma[i].length; j++) {
                        if (forma[i][j] == 1) {
                            console.log((Juego.mapa[vertical + i][horizontal]));
                            if ((Juego.mapa[vertical + i + 1][horizontal + j + auxiliar] == 'G')
                                    || (Juego.mapa[vertical + i + 1][horizontal + j + auxiliar] == 'P')
                                    || (Juego.mapa[vertical + i + 1][horizontal + j ] == 'P')) {
                                puede = false;
                            } else {
                                puede = true;
                            }
                        }
                    }
                }
                return puede;
            };

            Juego.movimiento();


        </script>
    </body>
</html>

